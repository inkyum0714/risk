
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ì¶¤ ì—¬í–‰ ì ìˆ˜ íŒë‹¨ ì„œë¹„ìŠ¤</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="top">
    <h2>ë§ì¶¤ ì—¬í–‰ ì ìˆ˜ íŒë‹¨ ì„œë¹„ìŠ¤</h2>
    <!-- ê²€ìƒ‰ í¼ -->
    <form class="search-form" action="/index" method="get" autocomplete="off">
        <div class="input-group">
            <label for="country-input-start">ì¶œë°œ</label>
            <input id="country-input-start" type="text" value="ëŒ€í•œë¯¼êµ­" disabled="true">
        </div>

        <div class="input-group">
            <label for="country-input">ë„ì°©</label>
            <input id="country-input" type="text" placeholder="ë‚˜ë¼, ë„ì‹œ, ê³µí•­ì¤‘ í•˜ë‚˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”" name="user_input_travel" required>
            <div id="autocomplete-list" class="autocomplete-list"></div>
        </div>

        <div class="input-group">
            <label for="user_input_day">ì¶œë°œì¼</label>
            <input type="date" id="user_input_day" name="user_input_day" required>
            <small id="date-warning" style="color: red; display: none; margin-top: 4px;">ê³¼ê±° ë‚ ì§œëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</small>
        </div>
        <button id="searchButton">ê²€ìƒ‰</button>
    </form>
</div>

<div class="recommended">
    <h2 style="margin-bottom: 20px; color: #333;">ì¶”ì²œ ì—¬í–‰ì§€</h2>
    {% for dest in destinations %}
    <div class="destination">
        <img src="{{ dest.image_url }}" alt="{{ dest.name }}">
        <div class="destination-info">
            <h3>{{ dest.name }}</h3>
            <p>ì—¬í–‰ ì ìˆ˜: <span class="score">{{ dest.score }}</span></p>
            <p>ì„¤ëª…: {{ dest.description }}</p>
        </div>
    </div>
    {% endfor %}
</div>


<!-- ğŸ”½ ê²€ìƒ‰ ê²°ê³¼ëŠ” ê·¸ ë‹¤ìŒ -->
<div class="bottom">
    <div id="response-container" class="weather-results"></div>
</div>
        <script>
            document.getElementById('searchButton').addEventListener('click', function(event){
                event.preventDefault();
                const cityInput = document.getElementById('country-input').value.trim();
                search();
            });

            async function search() {
                const user_input_travel = document.getElementById('country-input').value;
                const container = document.querySelector("#response-container")
                container.innerHTML = "";
                const url = "/search?user_input_travel="+user_input_travel;
                $.ajax({
                    url : url,
                    method : "GET",
                    success: function(response) {
                        let user_input_travel_data = response.result;
                        console.log(user_input_travel_data)
                        console.log(user_input_travel_data.country)
                        console.log(user_input_travel_data.city)
                        console.log(user_input_travel_data.airport)
                        getAllmain(user_input_travel_data.city, user_input_travel_data.country)
                    },
                    error: function(err) {
                        console.error("search AJAX error:", err);
                    }
                })
            }
        let existingData = getCookie("travelData");
        let dataArray = [];

        if (existingData) {
            try {
                dataArray = JSON.parse(existingData);
            } catch(e) {
                dataArray = [];
            }
        }
        function incrementProgress(target, step = 1, interval = 20) {
            return new Promise((resolve) => {
                const timer = setInterval(() => {
                    progress += step;
                    if (progress > target) progress = target; // ìµœëŒ€ê°’ ì œí•œ
                    progressBar.value = progress;
                    if (progress >= target) {
                        clearInterval(timer);
                        resolve();
                    }
                }, interval);
            });
        }
        function appendResult(message) {
            const container = document.querySelector("#response-container")
            const div = document.createElement("div")
            div.innerHTML = message
            container.appendChild(div)
        }
        async function getAllmain(user_input_travel_cities, user_input_travel_country) {
            const exchangeData = await exchange(user_input_travel_country);
            const exchangeRate = exchangeData.result;
            const symbol = exchangeData.symbol
            // 1. êµ­ê°€ ìœ„í—˜ë„ í•œ ë²ˆë§Œ ê°€ì ¸ì˜¤ê¸°
            const riskData = await risk(user_input_travel_country);
            const riskLevel = riskData.result.score;
            const alerts = riskData.result.alert;
            const color = riskLevel >= 10 ? '#ef4444' : riskLevel >= 6 ? '#f59e0b' : '#10b981';

            cookieData = {

            }
        
            // 2. ìœ„í—˜ë„ ì¶œë ¥ (ë§¨ ìœ„ì—)
            appendResult(`
                <div style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid ${color}; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: #333;">êµ­ê°€ ìœ„í—˜ë„</h3>
                    <span style="font-size: 32px; font-weight: bold; color: ${color};">${riskLevel}</span>
                    </div>
                    ${alerts && alerts.length > 0 ? `
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #eee;">
                        <p style="margin: 0 0 8px 0; font-weight: 600; color: #666;">ê²½ë³´:</p>
                        ${alerts.map(alert => `<p style="margin: 4px 0; color: #666;">â€¢ ${alert}</p>`).join('')}
                    </div>
                    ` : ''}
                </div>
            `);

            appendResult(`
                <div style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #3b82f6; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: #333;">í™˜ìœ¨ ì •ë³´</h3>
                <span style="font-size: 32px; font-weight: bold; color: #3b82f6;">${exchangeRate}</span>
            </div>
            <p style="margin-top: 12px; color: #666;">í˜„ì¬ ${user_input_travel_country}ì˜ 1${symbol} ë‹¨ìœ„ ê¸°ì¤€ ëŒ€í•œë¯¼êµ­ í™˜ìœ¨</p>
        </div>
        `);

            // 3. ê° ë„ì‹œë³„ ì—¬í–‰ ì¹´ë“œ ì¶œë ¥ (riskData ì „ë‹¬)
            for (const city of user_input_travel_cities) {
                await main(city, user_input_travel_country, riskData);
            }

        }

        // main() í•¨ìˆ˜ì—ì„œ riskDataë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ë„ë¡ ìˆ˜ì •
        async function main(user_input_travel_city, user_input_travel_country, riskData) {
            // ë„ì‹œë§ˆë‹¤ ê³ ìœ  ID ë¶€ì—¬
            const progressId = `progress-${user_input_travel_city.replace(/\s+/g, '-')}`;
            const labelId = `label-${user_input_travel_city.replace(/\s+/g, '-')}`;

            let progress = 0;
            try {
                appendResult(`
                    <div class="progress-container" id="container-${progressId}">
                        <label id="${labelId}" for="${progressId}" class="progress-label">
                            ${user_input_travel_city} ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </label>
                        <progress id="${progressId}" value="0" max="100"></progress>
                    </div>
                `);

                const progressBar = document.getElementById(progressId);
                const label = document.getElementById(labelId);

                // ë‚´ë¶€ ì „ìš© ì§„í–‰ í•¨ìˆ˜
                function incrementProgress(target, step = 1, interval = 20) {
                    return new Promise((resolve) => {
                        const timer = setInterval(() => {
                            progress += step;
                            if (progress > target) progress = target;
                            progressBar.value = progress;
                            if (progress >= target) {
                                clearInterval(timer);
                                resolve();
                            }
                        }, interval);
                    });
                }

                // weather
                const weatherPromise = weather(user_input_travel_city)
                    .then(async (weatherData) => {
                        await incrementProgress(40, 1, 15);
                        return weatherData;
                    });

                // airticket
                const ticketPromise = airticket(user_input_travel_city)
                    .then(async (ticketData) => {
                        await incrementProgress(80, 1, 15);
                        return ticketData;
                    });

                // ëª¨ë‘ ì™„ë£Œ
                const [weatherData, ticketData] = await Promise.all([weatherPromise, ticketPromise]);
               

                const total_score = await total(weatherData.result, ticketData.result, riskData.result.score);
                await incrementProgress(100, 1, 10);

                // ì™„ë£Œ í›„ ì§„í–‰ë°” ì œê±°
                const container = document.getElementById(`container-${progressId}`);
                container.remove();
                // ê²°ê³¼ í‘œì‹œ
                appendResult(`
                    <div class="travell-card fade-in">
                        <div class="card-header">
                            <h3 class="city-name" style="margin:0;">${user_input_travel_city}</h3>
                            <div class="total-score-container">
                                <p>ì´í•© ì ìˆ˜</p>
                                <span class="score-value">${total_score}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="info-section weather-section">
                                <span class="label">ë‚ ì”¨ ì ìˆ˜(ë¶ˆì¾Œ ì§€ìˆ˜)</span>
                                <span class="value">${weatherData.result}</span>
                            </div>
                            <div class="info-section score-section">
                                <span class="label">í•­ê³µê¶Œ ì ìˆ˜</span>
                                <span class="value score">${ticketData.result}</span>
                            </div>
                            <div class="ticket-details">
                                <h4 class="details-title">í•­ê³µê¶Œ ìƒì„¸ ì •ë³´</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <span class="detail-label">ê°€ê²©</span>
                                        <span class="detail-value price">${ticketData.result_data[0]["ê°€ê²©"] }</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">ìµœì´ˆ íƒ‘ìŠ¹ ì‹œê°„</span>
                                        <span class="detail-value">${ticketData.result_data[0]["ìµœì´ˆ íƒ‘ìŠ¹ ì‹œê°„"]}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">ë§ˆì§€ë§‰ íƒ‘ìŠ¹ ì‹œê°„</span>
                                        <span class="detail-value">${ticketData.result_data[0]["ë§ˆì§€ë§‰ íƒ‘ìŠ¹ ì‹œê°„"]}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">ìœ„íƒìˆ˜í•˜ë¬¼ ìš©ëŸ‰</span>
                                        <span class="detail-value">${ticketData.result_data[0]["ìœ„íƒìˆ˜í•˜ë¬¼ ìš©ëŸ‰"]}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">í•­ê³µì‚¬ ì´ë¦„</span>
                                        <span class="detail-value airline">${ticketData.result_data[0]["í•­ê³µì‚¬ ì´ë¦„"]}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                
                const dataItem = {
                    city: user_input_travel_city,
                    price: ticketData.result_data[0]["ê°€ê²©"],
                    weather: weatherData.result,
                    totalScore: total_score
                };
                const isDuplicate = dataArray.some(item => item.city === user_input_travel_city);
                if (!isDuplicate) {
                    dataArray.push(dataItem);
                }
                setCookie("travelData", JSON.stringify(dataArray), 7);
            } catch (err) {
                console.error("ì—ëŸ¬ ë°œìƒ:", err);
            } 
        }


            async function weather(city) {
                const date = document.getElementById('user_input_day').value;
                const res = await fetch(`/weather?user_input_travel_city=${city}&date=${date}`);
                return res.json(); 
            }

            async function airticket(city) {
                const date = document.getElementById('user_input_day').value;
                const res = await fetch(`/airticket?user_input_travel_city=${city}&date=${date}`);
                console.log(res)
                return res.json();
            }

            async function risk(country) {
                const date = document.getElementById('user_input_day').value;
                const res = await fetch(`/risk?user_input_travel_country=${country}&date=${date}`);
                return res.json();
            }

            async function exchange(country) {
                console.log(country)
                const res = await fetch(`/exchange?base=${country}`);
                console.log(res)
                return res.json();
            }
            async function total(weather, air_ticket, risk) {
                const res = await fetch(`/total?weather=${weather}&air_ticket=${air_ticket}&risk=${risk}`);
                const data = await res.json(); 
                return data.result; 
            }

            const countries = {{ country_code_data_five_number.keys() | list | tojson | safe }} || [];
            const cities = {{ country_code_data_three.keys() | list | tojson | safe }} || [];
            const airports = {{ airport_names | list | tojson | safe }} || [];
            const allPlaces = [...new Set([...countries, ...cities, ...airports])];
            const autocompleteList = document.getElementById('autocomplete-list');
            const input = document.getElementById('country-input');

            input.addEventListener('input', function() {
                const val = this.value.toLowerCase();
                autocompleteList.innerHTML = '';
                if (!val) return;

            const matches = allPlaces
                .filter(place => place.toLowerCase().includes(val))
                .slice(0, 10); 

            matches.forEach(match => {
                const item = document.createElement('div');
                item.classList.add('autocomplete-item');

                const startIndex = match.toLowerCase().indexOf(val);
                item.innerHTML = 
                    `${match.substring(0, startIndex)}<strong>${match.substr(startIndex, val.length)}</strong>${match.substr(startIndex + val.length)}`;

                item.addEventListener('click', function(e) {
                    e.stopPropagation(); 
                    input.value = match;
                    autocompleteList.innerHTML = '';
                });

                autocompleteList.appendChild(item);
            });
        });
        function getTravelDataList(cookieName) {
            const cookieValue = getCookie(cookieName);
            if (!cookieValue) return [];
            try {
                const decoded = decodeURIComponent(cookieValue); // ë””ì½”ë”© í•„ìˆ˜
                const data = JSON.parse(decoded);
                if (Array.isArray(data)) return data; 
                return [];
            } catch(e) {
                console.error("ì¿ í‚¤ íŒŒì‹± ì‹¤íŒ¨", e);
                return [];
            }
        }
        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days*24*60*60*1000));
            const expires = "expires=" + d.toUTCString();
            // ë°˜ë“œì‹œ encodeURIComponent ì ìš©
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
        }


        // ì¿ í‚¤ ê°€ì ¸ì˜¤ê¸°
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // ëœë¤ìœ¼ë¡œ nê°œ ë½‘ê¸°
        function getRandomCities(list, n) {
            const shuffled = list.slice().sort(() => 0.5 - Math.random());
            return shuffled.slice(0, n);
        }

        // ì¹´ë“œ HTML ìƒì„± í›„ appendResult í˜¸ì¶œ
        function appendTravelCard(cityData) {
            const cardHTML = `
            <div class="travell-card fade-in">
                <div class="card-header">
                    <h3 class="city-name">${cityData.city}</h3>
                    <div class="total-score-container">
                        <p>ì´í•© ì ìˆ˜</p>
                        <span class="score-value">${cityData.totalScore}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="info-section weather-section">
                        <span class="label">ë‚ ì”¨ ì ìˆ˜(ë¶ˆì¾Œ ì§€ìˆ˜)</span>
                        <span class="value">${cityData.weather}</span>
                    </div>
                    <div class="info-section price-section">
                        <span class="label">ê°€ê²©</span>
                        <span class="score-value">
                            ${cityData.price !== undefined ? cityData.price.toLocaleString() : 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'}
                        </span>
                    </div>
                </div>
            </div>
            `;
            appendResult(cardHTML);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', function() {
            const cityList = getTravelDataList('travelData');
            if (!cityList || cityList.length === 0) {
                console.log("ì¶”ì²œ ì—¬í–‰ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const randomCities = getRandomCities(cityList, 2); // 2ê°œ ì„ íƒ
            randomCities.forEach(city => {
                appendTravelCard(city); // appendResultë¥¼ í†µí•´ ì¹´ë“œ ì¶œë ¥
            });
        });

        </script>
    </body>
</html>
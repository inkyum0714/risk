<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>TSJ - service</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="top">
    <h2>travel Score Judgement</h2>
    <!-- 검색 폼 -->
    <form class="search-form" action="/index" method="get" autocomplete="off">
        <div class="input-group">
            <label for="country-input-start">출발</label>
            <input id="country-input-start" type="text" value="대한민국" disabled="true">
        </div>

        <div class="input-group">
            <label for="country-input">도착</label>
            <input id="country-input" type="text" placeholder="나라, 도시, 공항중 하나를 입력하세요" name="user_input_travel" required>
            <div id="autocomplete-list" class="autocomplete-list"></div>
        </div>

        <div class="input-group">
            <label for="user_input_day">출발일</label>
            <input type="date" id="user_input_day" name="user_input_day" required>
            <small id="date-warning" style="color: red; display: none; margin-top: 4px;">과거 날짜는 선택할 수 없습니다.</small>
        </div>
        <button id="searchButton">검색</button>
    </form>
</div>

<div class="recommended">
    <h2 style="margin-bottom: 20px; color: #333;">추천 여행지</h2>
    {% for dest in destinations %}
    <div class="destination">
        <img src="{{ dest.image_url }}" alt="{{ dest.name }}">
        <div class="destination-info">
            <h3>{{ dest.name }}</h3>
            <p>여행 점수: <span class="score">{{ dest.score }}</span></p>
            <p>설명: {{ dest.description }}</p>
        </div>
    </div>
    {% endfor %}
</div>


<div class="bottom">
    <div id="response-container" class="weather-results"></div>
</div>
        <script>
            document.getElementById('searchButton').addEventListener('click', function(event){
                event.preventDefault();
                const cityInput = document.getElementById('country-input').value.trim();
                search();
            });

            async function search() {
                const user_input_travel = document.getElementById('country-input').value;
                const container = document.querySelector("#response-container")
                container.innerHTML = "";
                const url = "/search?user_input_travel="+user_input_travel;
                $.ajax({
                    url : url,
                    method : "GET",
                    success: function(response) {
                        let user_input_travel_data = response.result;
                        console.log(user_input_travel_data)
                        console.log(user_input_travel_data.country)
                        console.log(user_input_travel_data.city)
                        console.log(user_input_travel_data.airport)
                        getAllmain(user_input_travel_data.city, user_input_travel_data.country)
                    },
                    error: function(err) {
                        console.error("search AJAX error:", err);
                    }
                })
            }
        let existingData = getCookie("travelData");
        let dataArray = [];

        if (existingData) {
            try {
                dataArray = JSON.parse(existingData);
            } catch(e) {
                dataArray = [];
            }
        }
        function incrementProgress(target, step = 1, interval = 20) {
            return new Promise((resolve) => {
                const timer = setInterval(() => {
                    progress += step;
                    if (progress > target) progress = target; // 최대값 제한
                    progressBar.value = progress;
                    if (progress >= target) {
                        clearInterval(timer);
                        resolve();
                    }
                }, interval);
            });
        }
        function appendResult(message) {
            const container = document.querySelector("#response-container")
            const div = document.createElement("div")
            div.innerHTML = message
            container.appendChild(div)
        }
        async function getAllmain(user_input_travel_cities, user_input_travel_country) {
            const exchangeData = await exchange(user_input_travel_country);
            const exchangeRate = exchangeData.result;
            const symbol = exchangeData.symbol
            // 1. 국가 위험도 한 번만 가져오기
            const riskData = await risk(user_input_travel_country);
            const riskLevel = riskData.result.score;
            const alerts = riskData.result.alert;
            const color = riskLevel >= 10 ? '#ef4444' : riskLevel >= 6 ? '#f59e0b' : '#10b981';

            cookieData = {

            }
        
            // 2. 위험도 출력 (맨 위에)
            appendResult(`
                <div style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid ${color}; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: #333;">국가 위험도</h3>
                    <span style="font-size: 32px; font-weight: bold; color: ${color};">${riskLevel}</span>
                    </div>
                    ${alerts && alerts.length > 0 ? `
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #eee;">
                        <p style="margin: 0 0 8px 0; font-weight: 600; color: #666;">경보:</p>
                        ${alerts.map(alert => `<p style="margin: 4px 0; color: #666;">• ${alert}</p>`).join('')}
                    </div>
                    ` : ''}
                </div>
            `);

            appendResult(`
                <div style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #3b82f6; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: #333;">환율 정보</h3>
                <span style="font-size: 32px; font-weight: bold; color: #3b82f6;">${exchangeRate}</span>
            </div>
            <p style="margin-top: 12px; color: #666;">현재 ${user_input_travel_country}의 1${symbol} 단위 기준 대한민국 환율</p>
        </div>
        `);

            // 3. 각 도시별 여행 카드 출력 (riskData 전달)
            for (const city of user_input_travel_cities) {
                await main(city, user_input_travel_country, riskData);
            }

        }

        // main() 함수에서 riskData를 매개변수로 받도록 수정
        async function main(user_input_travel_city, user_input_travel_country, riskData) {
            // 도시마다 고유 ID 부여
            const progressId = `progress-${user_input_travel_city.replace(/\s+/g, '-')}`;
            const labelId = `label-${user_input_travel_city.replace(/\s+/g, '-')}`;

            let progress = 0;
            try {
                appendResult(`
                    <div class="progress-container" id="container-${progressId}">
                        <label id="${labelId}" for="${progressId}" class="progress-label">
                            ${user_input_travel_city} 데이터 불러오는 중...
                        </label>
                        <progress id="${progressId}" value="0" max="100"></progress>
                    </div>
                `);

                const progressBar = document.getElementById(progressId);
                const label = document.getElementById(labelId);

                // 내부 전용 진행 함수
                function incrementProgress(target, step = 1, interval = 20) {
                    return new Promise((resolve) => {
                        const timer = setInterval(() => {
                            progress += step;
                            if (progress > target) progress = target;
                            progressBar.value = progress;
                            if (progress >= target) {
                                clearInterval(timer);
                                resolve();
                            }
                        }, interval);
                    });
                }

                // weather
                const weatherPromise = weather(user_input_travel_city)
                    .then(async (weatherData) => {
                        await incrementProgress(40, 1, 15);
                        return weatherData;
                    });

                // airticket
                const ticketPromise = airticket(user_input_travel_city)
                    .then(async (ticketData) => {
                        await incrementProgress(80, 1, 15);
                        return ticketData;
                    });

                // 모두 완료
                const [weatherData, ticketData] = await Promise.all([weatherPromise, ticketPromise]);
               

                const total_score = await total(weatherData.result, ticketData.result, riskData.result.score);
                await incrementProgress(100, 1, 10);

                // 완료 후 진행바 제거
                const container = document.getElementById(`container-${progressId}`);
                container.remove();
                // 결과 표시
                appendResult(`
                    <div class="travell-card fade-in">
                        <div class="card-header">
                            <h3 class="city-name" style="margin:0;">${user_input_travel_city}</h3>
                            <div class="total-score-container">
                                <p>총합 점수</p>
                                <span class="score-value">${total_score}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="info-section weather-section">
                                <span class="label">날씨 점수(불쾌 지수)</span>
                                <span class="value">${weatherData.result}</span>
                            </div>
                            <div class="info-section score-section">
                                <span class="label">항공권 점수</span>
                                <span class="value score">${ticketData.result}</span>
                            </div>
                            <div class="ticket-details">
                                <h4 class="details-title">항공권 상세 정보</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <span class="detail-label">가격</span>
                                        <span class="detail-value price">${ticketData.result_data[0]["가격"] }</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">최초 탑승 시간</span>
                                        <span class="detail-value">${ticketData.result_data[0]["최초 탑승 시간"]}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">마지막 탑승 시간</span>
                                        <span class="detail-value">${ticketData.result_data[0]["마지막 탑승 시간"]}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">위탁수하물 용량</span>
                                        <span class="detail-value">${ticketData.result_data[0]["위탁수하물 용량"]}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">항공사 이름</span>
                                        <span class="detail-value airline">${ticketData.result_data[0]["항공사 이름"]}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                
                const dataItem = {
                    city: user_input_travel_city,
                    price: ticketData.result_data[0]["가격"],
                    weather: weatherData.result,
                    totalScore: total_score
                };
                const isDuplicate = dataArray.some(item => item.city === user_input_travel_city);
                if (!isDuplicate) {
                    dataArray.push(dataItem);
                }
                setCookie("travelData", JSON.stringify(dataArray), 7);
            } catch (err) {
                console.error("에러 발생:", err);
            } 
        }


            async function weather(city) {
                const date = document.getElementById('user_input_day').value;
                const res = await fetch(`/weather?user_input_travel_city=${city}&date=${date}`);
                return res.json(); 
            }

            async function airticket(city) {
                const date = document.getElementById('user_input_day').value;
                const res = await fetch(`/airticket?user_input_travel_city=${city}&date=${date}`);
                console.log(res)
                return res.json();
            }

            async function risk(country) {
                const date = document.getElementById('user_input_day').value;
                const res = await fetch(`/risk?user_input_travel_country=${country}&date=${date}`);
                return res.json();
            }

            async function exchange(country) {
                console.log(country)
                const res = await fetch(`/exchange?base=${country}`);
                console.log(res)
                return res.json();
            }
            async function total(weather, air_ticket, risk) {
                const res = await fetch(`/total?weather=${weather}&air_ticket=${air_ticket}&risk=${risk}`);
                const data = await res.json(); 
                return data.result; 
            }

            const countries = {{ country_code_data_five_number.keys() | list | tojson | safe }} || [];
            const cities = {{ country_code_data_three.keys() | list | tojson | safe }} || [];
            const airports = {{ airport_names | list | tojson | safe }} || [];
            const allPlaces = [...new Set([...countries, ...cities, ...airports])];
            const autocompleteList = document.getElementById('autocomplete-list');
            const input = document.getElementById('country-input');

            input.addEventListener('input', function() {
                const val = this.value.toLowerCase();
                autocompleteList.innerHTML = '';
                if (!val) return;

            const matches = allPlaces
                .filter(place => place.toLowerCase().includes(val))
                .slice(0, 10); 

            matches.forEach(match => {
                const item = document.createElement('div');
                item.classList.add('autocomplete-item');

                const startIndex = match.toLowerCase().indexOf(val);
                item.innerHTML = 
                    `${match.substring(0, startIndex)}<strong>${match.substr(startIndex, val.length)}</strong>${match.substr(startIndex + val.length)}`;

                item.addEventListener('click', function(e) {
                    e.stopPropagation(); 
                    input.value = match;
                    autocompleteList.innerHTML = '';
                });

                autocompleteList.appendChild(item);
            });
        });
        function getTravelDataList(cookieName) {
            const cookieValue = getCookie(cookieName);
            if (!cookieValue) return [];
            try {
                const decoded = decodeURIComponent(cookieValue); // 디코딩 필수
                const data = JSON.parse(decoded);
                if (Array.isArray(data)) return data; 
                return [];
            } catch(e) {
                console.error("쿠키 파싱 실패", e);
                return [];
            }
        }
        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days*24*60*60*1000));
            const expires = "expires=" + d.toUTCString();
            // 반드시 encodeURIComponent 적용
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
        }


        // 쿠키 가져오기
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // 랜덤으로 n개 뽑기
        function getRandomCities(list, n) {
            const shuffled = list.slice().sort(() => 0.5 - Math.random());
            return shuffled.slice(0, n);
        }

        // 카드 HTML 생성 후 appendResult 호출
        function appendTravelCard(cityData) {
            const cardHTML = `
            <div class="travell-card fade-in">
                <div class="card-header">
                    <h3 class="city-name">${cityData.city}</h3>
                    <div class="total-score-container">
                        <p>총합 점수</p>
                        <span class="score-value">${cityData.totalScore}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="info-section weather-section">
                        <span class="label">날씨 점수(불쾌 지수)</span>
                        <span class="value">${cityData.weather}</span>
                    </div>
                    <div class="info-section price-section">
                        <span class="label">가격</span>
                        <span class="score-value">
                            ${cityData.price !== undefined ? cityData.price.toLocaleString() : '데이터가 없습니다'}
                        </span>
                    </div>
                </div>
            </div>
            `;
            appendResult(cardHTML);
        }

        // 페이지 로드 시 실행
        window.addEventListener('load', function() {
            const cityList = getTravelDataList('travelData');
            if (!cityList || cityList.length === 0) {
                console.log("추천 여행지가 없습니다.");
                return;
            }

            const randomCities = getRandomCities(cityList, 2); // 2개 선택
            randomCities.forEach(city => {
                appendTravelCard(city); // appendResult를 통해 카드 출력
            });
        });

        </script>
    </body>
</html>